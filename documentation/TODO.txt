Test at http://localhost:81/alttp/public/

High Priority Bugs:
    Player leaves swimming animation during transitions:
        Both when moving through doors and scrolling between super tiles
        This doesn't happen during transitions inside super tiles.
        - Could solve by setting swimming as a flag instead of an action, which might otherwise be useful.
    Objects shouldn't be able to float on top of pits.
        - Make objects fall in pits.
        - Pit entrance should pull you in like other pits

Low Priority Bugs:
    Pushing on a solid object sitting on thorny ground shouldn't hurt you:
        -return tileBehaviors and objectBehaviors separately, only damage if tile is solid+damaging.
    Doors don't appear open when moving into them from a different section
        I think this is because the door doesn't update until it is in the current areaInstance
    nextAreaInstance is not rendered in Safari

Outstanding Questions:
    - Is default linking bushes/rocks a problem, since they will sometimes hit spirit enemies players cannot see and think it is a bug? Maybe don't have many spirit enemies spawn early in the game, or only have them spawn places where the player is unlikely to throw objects (perhaps places with no objects to throw, or only lvl 2 glove object?)
    - Do we want to implement one way links like physical effects spirit but not the other? It would make sense, but seems like a lot of work, so let's not do this for now unless we see some obvious wins. It is also a bit more complicated for the player to understand, especially if we have doubly linked, linked each way, and unlinked pairs.

Graphics:
    Sweat animation when pulling on something you cannot move.
    Add Item Get Frame gfx/wukongimportantitem.png 20x28
    Add fall animation for objects that fall into pits (this isn't implemented yet)
    Add sparkles to peach loot + hud.
    Add damage effects for hitting enemies?
    Add damage effect for player hurt? (alttp doesn't have anything like this)

Todo:

Dungeon 1:
    - Vanara burial grounds
    - Traps+locks to keep intruders away. Need to use bow to enter
        - Someone was stealing Vanara remains
    - Located near the main Vanara village in the Southwest forest
    - Built around a suspended animation capsule
        - The Vanara population is too large so they rotate members in and out of suspended animation.
        - Suspension pods erase Vanara memories to prevent then from becoming restless.
        - Pods also regenerate Vanara bodies, which would break down without nurishment from the spirit world.
        - Vanara village population is 20-30 individuals at a time. There are 100-300 total, most suspended.
    - The goal of the dungeon is to meet with the care taker who looks after and maintains the suspended Vanara.
        - The original Vanara crew rotate members into the care taker role once every X years.
    - A facade is built aroaund the structure to disguise it as a mundane structure
        - The Vanara village posts guards in addition to the traps to keep people out
    - MCs father refused to go back to sleep, having fallen in love with MCs mother and not wanting to forget about her.


Dungeon flavor philosophy:
    All Vanara structures are part of the Vanara ship and related to some functionality, such as the regeneration pods.
    Vanara spirit structures allow free exploration in astral projection because Vanara spirits can tether to the Vanara ship and leave their bodies behind. If the MC knows how to teleport, they can use this to free travel around the world.
    All Native structures are built to native spirit gods who functioned as sevants to the old native spirit beings and were created for specific purposes like resource harvesting, processing and crafting.

Ability order:
    Completing the Peach Cave awakens MCs spirit abilities giving them their spirit bar + cat eyes.
    They visit the care taker to obtain spirit sight, they are then instructed to learn astral projection + teleportation to visit the Vanara command center



Current tasks:
    - Give loot during dialogue
    - Add dialogue logic UI
        - Priority list of dialogue options an MC can show
        - Each entry has the following sections:
            - A grab bar on the left for dragging the option up/down (copy this UI over for layers as well)
            - An "if" logic section for all flags required to show the dialogue
            - A 'not' logic section for any flags that disable the dialogue
            - A check box indicating dialogue is exclusive. The first valid exclusive dialogue found will be automatically chosen.
            - A progress flag that can be specified to set a flag when the dialogue has been encountered, similary to unlocking doors, opening chests or beating bosses. Including this id in the 'not' logic makes the dialogue unique and should be done for any dialogue that rewards an item.
            - A long textbox for the dialogue itself
        - When talking to an NPC, the list of options is read in order, and all valid options are added to an array. If an exclusive option is found, that dialogue is shown. If not, a random dialogue is shown from the list of valid options. Or perhaps we cycle through all available options in order.
    - Wall Lasers
        - Support param editing for enemies
        - Change how state for various object definitions are stored by keeping the entire ObjectDefinition for the object to create in state.
    - Difficulty shrine:
        - 50 money per point
        - move points around for free
        - second chance = faerie
            - 100/200/300/400 for a filled chance, 50 for a refill
        - Or second chance is only for boss, and have a single refill tank that you can charge like in metroid?
        - Remove boss webs
        - Reduce boss health

Add NPCs:
    Basically moving signs that look like the MC for now.

Idea:
    Objects you can bounce off of when jumping
        - Just make them solid and knock the player back a bit if the player's y velocity is >= some value?

Peach Cave Improvemnts:
    - Add enemies:
        - Eggs that hatch into enemies if not destroyed first
        - Vine enemies that can be knocked to the ground
    - Sticky Web Ground
    - Make cliffs omni directional (but you can't jump from 'climbing')
    - Add boss:
        - Spawns eggs
        - Drains light and regains a bit of health for every 25% lost


Apply element to charge abilities.
    Costs an additional 10 mana for the element

Additional Clone Tool Behavior:
    Charging the clone 1 level adds elements to the clones weapon/tools/explosion.
    Charging the clone 1 level without elements makes it invulnerable for 4 seconds.

Quick Demo
    - Start with 6 hearts + weapon
    - Invisibility tool section
    - Staff tool section
    - Charge tool to unlock lvl 2 tools
    - Combined tool puzzles

Dungeon 1: Vanara Temple
    - Find dodge roll technique, required to complete.
    - Vanara spirit tests you and teaches spirit sight. Maybe mentions the Vanara aren't supposed to be developing their spirit abilities but is obligated to train anyone who proves themselves. Maybe rival has already been there:
        - Rival is leaving as you enter or
        - Rival meets you as you are leaving and challenges you to a duel to test your abilities.

Add ability to charge weapon
    Spin chakram around quickly in a circle twice (can move after throwing)
    Costs 10 mana

    Charge level 2 requires level 2 charge ability + level 2 weapon
    Costs 50 mana
    Similar to level 1 but 2 chakrams spin around you at different radiuses for 4 seconds.

Multi-area Boss ideas:
    - Plant-like boss that is growing in several chambers that you have to move between to defeat.
    - Boss that escapes and must be chased to different chambers.

Add Small Loot to editor that creates LootDrop
    - locked to tile grid
    - if on destructable tile (cuttable, pickup), not rendered/updated until the tile is destroyed.
        - This should actually be done for any loot, this will make it easy to hide keys under objects.
        - We can support progress items under tiles, but probably shouldn't actually use this in practice in order to avoid players searching under every tile. On the other hand, if we clearly telegraph when this happens, maybe we can void this problem and encourage players to use smart ways to check for things (like spirit sight to search under many objects for a key).
    - keep a hash of picked up objects in dungeons so these only replenish on leaving the dungeon.
    - Add an editor option to clear the history of picked up small loots.


Add ability to charge tools.

Add ability to charge carried objects
    Hold the passive button when picking up an object to charge
    Charge level is limited both by level of gloves/bracers and charge level.
    Should add selected element to thrown object


Add astral projection + telekinesis abilities
    - if astral projection is available, you can move around (need to press passive tool on body to return or press something else to return instantly?)
    - if telekinesis you can pick up real objects if they have stable spirit elements (possibly limited by telekinesis level)


Add upstairs/downstairs:
    Same definition as door, but different graphics + animation
        - targets are opposite stair types.
        - log error if stairs without target are found
            - Maybe log error if stairs don't connect to either a different zone or the correct floor in current zone
        - Link back to themselves if no target is defined.


Improve Tool Selection:
    - Track most recent input to control keyboard vs controller type
    - Color around the selection + HUD indicator should match the color of the controller button (blue + yellow for X-Box)
    - Display a letter attached to the selection based on the button/keyboard key.

Additionl Invisibility Tool Behavior:
    Charge to deal elemental damage on contact while invisible.
    Can move through activatable crystals and some other obstacles.
        * charge invisibility then dodge roll through a line of crystals to activate them quickly.

Additional Staff Behavior:
    Should damage enemies + knock them away
    Eventually Lvl 2 staff can be used to create the Staff Tower.
    - The sides of the staff should function as a wall rather than open ground.
    Charging the staff does a very large spin attack that knocks enemies away.
        Lvl 2 charge is a screen wide attack the applies damage+element to all enemies.



Update collision detection and wiggle logic:
    - Create an array that is the width of the character(relative to movement direction) + 16
    - Assuming entry 8 = [ax, ay] and length - 9 = [ax + width - 1, ay] (for moving up or down) check pairs of 0 and 3 pixels every 4 pixels, so for w = 16, check 8+11,12+15,16+19,20+23. If any are blocked, movement is blocked, remember the blocked pixel index.
    - If movement is blocked if blocked index <= length / 2 then scan right starting at blocked index + 1. If w open pixels are found, wiggle right. If a blocked pixel is found at index >= length - w, then abort, wiggling is not possible.
    - If blocked index > length / 2, repeat the above except scanning left to check for left wiggle.

Some puzzle ideas:
    - A puzzle where 4 switches need to be hit in 200ms, you can blow up the clone in the middle to activate all at once.
    - If we place a block on top of a switch that toggles on release, we can make a door that requires you to push the block off of the switch.

Track the object an arrow is stuck in and move it with that target until it disappears
    - Use a different 'stuck' frame for the arrow missing the head.

Animate hearts refilling

Add spirit element that replaces the default 'none' element when the upgrade is found. In vanilla this would require getting all other elements first.


Add offering shrines in dungeons that allow players to adjust the difficulty by paying 50 money:
    - Take 1/2 damage
    - 1/2 boss life
    - easier traps (disable conveyer belts, remove spikes)
    - easier puzzles (required chests are made distinct from optional chests, positions of required items are moved to more easily accessible locations)

Include some random dungeon design in the base game:
    - Location of key under object might change (there should be some clue where it is or use spirit sight).
    - Something like peg cave, but only a single peg needs to be pressed to open it (spirit sight reveals which?).
    - Something like Eastern Palace Foyer except the correct door isn't always the center door.

Keep in mind significance of design elements for future racing/randomizer.

Add quick tool select ring on the right analog stick.

Support 64x64 super tiles for world map. Or maybe just 48x48. Probably add this after Spirit World mechanics to make sure they perform okay together.

Possible tool: Leather gloves protect you from thorn bushes.
Possible tool: Leather boots let you walk on thorny ground without taking damage.
