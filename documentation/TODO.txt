Test at http://localhost:81/alttp/public/

Low Priority Bugs:
    - Enemies can walk on stairs cases and over bead flows
        - Add an invisible enemy wall object?
    - Astral Projection appears in front of waterfall graphics only when south of main body in waterfall tower.
    - Clean up attack effects on defeating bosses.
        - Need to set a flag on all attack effects so they are easy to find and remove.
    - Foreground only renders for the active area, should render for the alternate area as well.
    - Pushing on a solid object sitting on thorny ground shouldn't hurt you:
        -return tileBehaviors and objectBehaviors separately, only damage if tile is solid+damaging.
    - Doors don't appear open when moving into them from a different section
        I think this is because the door doesn't update until it is in the current areaInstance
    - nextAreaInstance is not rendered in Safari
    - frost grenade blast isn't centered.

High Priority Bugs:
    Sometimes can't enter peach cave when sliding on ice?


Graphics:
    Sweat animation when pulling on something you cannot move.
    Add Item Get Frame gfx/wukongimportantitem.png 20x28
    Add sparkles to peach loot + hud.
    Add damage effects for hitting enemies?
    Add damage effect for player hurt? (alttp doesn't have anything like this)


Current tasks:
    - Waterfall Tower
        - Make bead flows act like shallow water for when you are walking in them?
            - This might not be the right animation for beads though.
        - Missing mechanics
            Make Crystal Spikes uncover the tiles they hit.
                - Add uncover effect to hits.
            Bead flows
                It would be nice to somehow treat the south edge of the flow as a wall when walking north, the current treatment is jittery with the knockback.
            Rusty floor switch that only activates if you fall on it wearing iron boots.
        - Boss: Crystal Collector
            - Add better spike attacks for main phase
            - Add better spike attacks for enrage
            - Passively summon spikes periodically whenever there are no floor eyes.
            - Passively enable bead cascades for 4 seconds every 5 seconds
                - Reduce to every 3 seconds for the final phase


    - Add dialogue objects that can trigger on entering areas or other triggers.
    - Add saveStatusLocally flag that saves an id to a hash that is erased when changing zones.
        - Use this to prevent large enemies like ents + crystal guardians from respawning when you just leave a screen.
    - Change message rendering system to use the priority queue system to support nested messages.
    - Add new waterfall graphics
    - Add touchHit behavior to tiles that can define full hit properties for tiles/objects on touch
        - Add 'barrierDamage' to hit properties that will control exact magic damage when hitting the spirit barrier.
        - Set barrierDamage lower for clearable traps like thorns to allow players to walk through and clear them using spirit barrier. Set even lower for floor traps that cannot be cleared since they will hit every frame.

    - Randomizer improvements
        - Add a goal
    - Change level 1 invisibility to spirit barrier
        - Charge adds element effect to barrier and reduces spirit loss to damage of that type
        - Level 2 adds invisibility which allows you to pass through damage barriers entirely and ignore ground effects like ice
    - brainstorm some dungeon/boss ideas, maybe for Staff Tower


High level list of things left to do:
    New dungeons(need enemies, mechanics, bosses, entrances):
        Grand Temple
        Jade Palace
        Sky Temple
        Forest Temple
        Crater
        Forge
        Warship
    Areas missing significant content:
        Waterfall Temple
        River Temple
        Staff Tower
    Missing Bosses for existing areas:
        River Temple Boss
        Rival fight before Tomb
        Tomb Boss
        Rival fight before Helix
        Cocoon Boss
        Waterfall Temple Boss
    Missing mechanics:
        Difficulty shrines
    Items missing implementation:
        Charge level 2
        Setting up Staff Tower
        Bow level 2
        Bow charge 1 + 2
        Invis charge 1 + 2
        Clone charge 1 + 2
        Cloud boots: walking on clouds
        Fire Blessing
        True Sight
        Iron Skin (slowly regenerates health shield = 20% total health)
        Gold Mail (reduce damage by 50%)
        Gloves charge 1 + 2

Add toasts to development for undoing actions:
    - Deleting layers
    - Replacing > 100 tiles

Cloud Boots:
    - Fall slower while wearing cloud boots
    - While moving with cloud boots on, slowly increase z value up to +4 as long as you are on solid ground. You should then naturally fall back to 0 while still or over pits.
        - The idea is that you can run over short gaps with cloud boots and also avoid floor damage as long as you keep moving.
    - Allow running over clouds (when implemented)
    - Maybe make falling in the sky behave like falling in a pit where you reset to safe location rather than falling to the overworld?

Difficulty shrine:
    - 50 money per point
    - move points around for free
    - second chance = faerie
        - 100/200/300/400 for a filled chance, 50 for a refill
    - Or second chance is only for boss, and have a single refill tank that you can charge like in metroid?
    - Remove boss webs
    - Reduce boss health
    - Take 1/2 damage
    - 1/2 boss life
    - easier traps (disable conveyer belts, remove spikes)
    - easier puzzles (required chests are made distinct from optional chests, positions of required items are moved to more easily accessible locations)


Charge Chakram Attack:
    - Maybe change level 1 charge to spin around hero in a circle twice? Brief 0.5s invulnerability with attack animation.
    - Charge level 2 could have 2 chakrams spin at different radiuses and directions? 50 mana, lasts 4 seconds.

At some point I should write tests to validate certain things like:
    - All zone+object targets are defined.
    - All bombable + locked doors have ids, all objects with saveStatus set have ids.
    - All objectFlags correspond to some object or dialogue key or loot type
    - All escaped dialogue corresponds to a special frame or loot type.

Apply element to charge abilities.
    Costs an additional 10 mana for the element

Additional Clone Tool Behavior:
    Charging the clone 1 level adds elements to the clones weapon/tools/explosion.
    Charging the clone 1 level without elements makes it invulnerable for 4 seconds.


Peach Cave Improvements:
    - Add enemies:
        - Eggs that hatch into enemies if not destroyed first
        - Vine enemies that can be knocked to the ground
    - Sticky Web Ground
    - Make cliffs omni directional (but you can't jump from 'climbing')
    - Add boss:
        - Spawns eggs
        - Drains light and regains a bit of health for every 25% lost

Dungeon 1 Improvements:
    - Add rival fight when you open the door:
        - Rival guards the tomb
        - Rival is angered you have the Spirit Bow when you hit one of the switches.
        - If you are defeated, the elder may save you, otherwise it is game over.
    - Update wall laser graphics+behavior to actuall shoot lasers + be mounted on walls.
    - Update arrow turret graphics.

Dungeon 2 Improvements:
    - Add more uses of spirit sight:
        - See actual elemental beasts in the front room where the statues are located.
        - Some kind of optional spirit sight puzzle for a peach piece.

Dungeon 3 Improvements:
    - Add a required progress puzzle defeating enemies with rolling stones using spirit sight.
    - Make the guardian's projection use more interesting attacks.
    - Animate the ents when they attack.

River Temple Improvements:
    - Some underwater enemies
    - Some crab enemies with ice shells that require fire element to defeat


Multi-area Boss ideas:
    - Plant-like boss that is growing in several chambers that you have to move between to defeat.
    - Boss that escapes and must be chased to different chambers.

Add Small Loot to editor that creates LootDrop
    - locked to tile grid
    - if on destructable tile (cuttable, pickup), not rendered/updated until the tile is destroyed.
        - This should actually be done for any loot, this will make it easy to hide keys under objects.
        - We can support progress items under tiles, but probably shouldn't actually use this in practice in order to avoid players searching under every tile. On the other hand, if we clearly telegraph when this happens, maybe we can void this problem and encourage players to use smart ways to check for things (like spirit sight to search under many objects for a key).
    - keep a hash of picked up objects in dungeons so these only replenish on leaving the dungeon.
    - Add an editor option to clear the history of picked up small loots.


Add ability to charge carried objects
    Hold the passive button when picking up an object to charge
    Charge level is limited both by level of gloves/bracers and charge level.
    Should add selected element to thrown object
    Apply element changes to tiles while you hold them (bush might burn up into ash in your hands with fire element, or turn to ice)


Improve Tool Selection:
    - Color around the selection + HUD indicator should match the color of the controller button (blue + yellow for X-Box)
    - Display a letter attached to the selection based on the button/keyboard key.

Additional Invisibility Tool Behavior:
    Charge to deal elemental damage on contact while invisible.
    Can move through activatable crystals and some other obstacles.
        * charge invisibility then dodge roll through a line of crystals to activate them quickly.

Additional Staff Behavior:
    Should damage enemies + knock them away
    Eventually Lvl 2 staff can be used to create the Staff Tower.
    - The sides of the staff should function as a wall rather than open ground.
    Charging the staff does a very large spin attack that knocks enemies away.
        Lvl 2 charge is a screen wide attack the applies damage+element to all enemies.



Update collision detection and wiggle logic:
    - Create an array that is the width of the character(relative to movement direction) + 16
    - Assuming entry 8 = [ax, ay] and length - 9 = [ax + width - 1, ay] (for moving up or down) check pairs of 0 and 3 pixels every 4 pixels, so for w = 16, check 8+11,12+15,16+19,20+23. If any are blocked, movement is blocked, remember the blocked pixel index.
    - If movement is blocked if blocked index <= length / 2 then scan right starting at blocked index + 1. If w open pixels are found, wiggle right. If a blocked pixel is found at index >= length - w, then abort, wiggling is not possible.
    - If blocked index > length / 2, repeat the above except scanning left to check for left wiggle.

Some puzzle ideas:
    - A puzzle where 4 switches need to be hit in 200ms, you can blow up the clone in the middle to activate all at once.
    - If we place a block on top of a switch that toggles on release, we can make a door that requires you to push the block off of the switch.

Track the object an arrow is stuck in and move it with that target until it disappears
    - Use a different 'stuck' frame for the arrow missing the head.

Animate hearts refilling

Add spirit element that replaces the default 'none' element when the upgrade is found. In vanilla this would require getting all other elements first.

Idea:
    Objects you can bounce off of when jumping
        - Just make them solid and knock the player back a bit if the player's y velocity is >= some value?

Include some random dungeon design in the base game:
    - Location of key under object might change (there should be some clue where it is or use spirit sight).
    - Something like peg cave, but only a single peg needs to be pressed to open it (spirit sight reveals which?).
    - Something like Eastern Palace Foyer except the correct door isn't always the center door.

Keep in mind significance of design elements for future racing/randomizer.

Support 64x64 super tiles for world map. Or maybe just 48x48. Probably add this after Spirit World mechanics to make sure they perform okay together.

Possible tool: Leather gloves protect you from thorn bushes.
Possible tool: Leather boots let you walk on thorny ground without taking damage.


Dungeon flavor philosophy:
    All Vanara structures are part of the Vanara ship and related to some functionality, such as the regeneration pods.
    All Native structures are built to native spirit gods who functioned as servants to the old native spirit beings and were created for specific purposes like resource harvesting, processing and crafting.


Ability Locations:
# Prologue
    weapon 1            Peach Cave Chest
    catEyes             Peach Cave Boss
# Starting Dungeons
    bow                 Vanara Village
    roll                Vanara Tomb Chest
    spiritSight         Vanara Tomb Boss
    gloves              Summoner Ruins Chest
    astralProjection    Summoner Ruins Boss
    spiritCloak         Cocoon Chest
    teleportation       Cocoon Boss
# Treasure Dungeons
    cloudBoots          Forest Temple Chest
    clone               Forest Temple Boss
    ironBoots           Waterfall Tower Chest
    spiritCloak 2       Waterfall Tower Boss
    gloves 2            Forge Chest
    goldMail            Forge Boss
    roll 2              Cloud Temple Chest
    nimbusCloud         Cloud Temple Boss
    bow 2               Grand Temple Chest
    ironSkin            Grand Temple Boss
    trueSight           Jade Palace Chest
    phoenixCrown        Jade Palace Boss
# First Quest Dungeon
    staff               Helix Chest
    charge              Helix Boss
# Middle Quest Dungeons
    fireBlessing        Crater Big Chest
    fire                Crater Boss Flame Beast
    waterBlessing       River Temple Big Chest
    ice                 River Temple Boss Frost Beast
    lightning           Staff Tower Boss Storm Beast
    staff 2             Staff Tower "Chest" (after boss)
    weapon 2            Acquired with first Element
    charge 2            Acquired with second Element
# Final Quest Dungeon
    clone 2             Warship Chest

Ability order:

Early Dungeons:
    Peach Cave: Completing the cave awakens MCs spirit abilities giving them their spirit bar + cat eyes.
    Vanara Village: Get the bow from the elder.
    Vanara Tomb: Dodge Roll in big chest, Spirit Sight from the Vanara Guardian.
    Summoner Ruins: Bracers in big chest, Astral Projection after defeating the boss.
    Vanara Tomb-Regeneration Unit: spiritCloak in big chest, Teleportation from Vanara Guardian.
    Helix: Tree Staff in big chest, charge from Vanara Captain.

Elemental Beasts: (triggered by Helix or entering the Spirit World)
    River Temple(Old Fertility Temple: Water Blessing Big Chest, Frost Beast(ice element)
    Mountain Crater: Fire Blessing Big Chest, Flame Beast(fire element)
    Staff Tower: Storm Beast(lightning element) + Tower Staff in Big Chest after boss

Late Dungeons:
    Forest Temple(New Fertility Temple):
    Waterfall Tower: Iron Boots in chest, spiritCloak 2 on boss
    The Forge: Gloves 2 in chest, gold mail on boss
    Grand Temple: Bow 2 chest, iron Skin from boss
    Jade Palace: True Sight in chest, Phoenix Crown on boss
    Cloud Temple: Roll 2 in chest, Nimbus Cloud on boss.

Final Dungeon:
    Warship: Clone 2 in big chest

Dungeon 1: Vanara Tomb (fortress around the Cocoon)
    - Traps+locks to keep intruders away. Need to use bow to enter
        - Someone was stealing Vanara remains
    - Built around a suspended animation capsule
        - The Vanara population is too large so they rotate members in and out of suspended animation.
        - Suspension pods erase Vanara memories to prevent then from becoming restless.
        - Pods also regenerate Vanara bodies, which would break down without nurishment from the spirit world.
        - Vanara village population is 20-30 individuals at a time. There are 100-300 total, most suspended.
    - The goal of the dungeon is to meet with the care taker who looks after and maintains the suspended Vanara.
        - The original Vanara crew rotate members into the care taker role once every X years.
    - A facade is built aroaund the structure to disguise it as a mundane structure
        - The Vanara village posts guards in addition to the traps to keep people out
    - MCs father refused to go back to sleep, having fallen in love with MCs mother and not wanting to forget about her.


Dungeon 2: Ruins of Summoner village and Temple of War
    - Expected loadout: Cat Eyes, 6 hearts, Dodge, Bow, Spirit Sight
    - Enemies: Flame/Frost/Storm mobs
    - Big Chest: Gloves 1
    - Boss: Elemental idols
    - Boss Reward: Astral Projection

Dungeon 3: Cocoon (Vanara Regeneration Unit)
    - Expected loadout: Cat Eyes, 7 hearts, Dodge, Bow, Spirit Sight, Gloves, Astral Projection
    - Enemies
    - Big Chest: Invisibility Technique
    - Boss:
    - Boss Reward: Teleportation (body moves to astral projection when pressing either tool button)


River Temple:
    - No NPCs here, this was the old Fertility Temple, but it was destroyed by the Varuna Ship crashing. The survivors all moved to the new Fertility Temple near the forest (Forest Temple).
